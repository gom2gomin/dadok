<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.choongang.s202350103.OrderrMapper2">
	<select id="htOrderTotal" parameterType="Orderr" resultType="int">
		SELECT count(*) FROM member
	</select>
	
	<select id="htOrderOne" parameterType="NewBook" resultType="NewBook">
		SELECT *
		FROM   newbook
		WHERE  nb_num = #{nb_num}
	</select>
	
	<select id="htOrderList" parameterType="Cart" resultType="Cart">
		SELECT c.*, n.nb_title, n.nb_price, n.nb_image, n.nb_publisher
		FROM   cart c, newbook n
		WHERE  c.nb_num = n.nb_num
		AND    m_num = #{m_num}
	</select>
	 
	<select id="htOrderInsert" statementType="CALLABLE" parameterType="Orderr" >
		{ 
			call Insert_order_detail(
					#{m_num         , mode=IN   , jdbcType=INTEGER}
				   ,#{o_pay_price   , mode=IN   , jdbcType=INTEGER}
				   ,#{o_pay_type    , mode=IN   , jdbcType=INTEGER}
				   ,#{o_deliv_price , mode=IN   , jdbcType=INTEGER}
				   ,#{o_point       , mode=IN   , jdbcType=INTEGER}
				   ,#{o_rec_name    , mode=IN   , jdbcType=VARCHAR}
				   ,#{o_rec_mail    , mode=IN   , jdbcType=VARCHAR}
				   ,#{o_rec_ph      , mode=IN   , jdbcType=VARCHAR}
				   ,#{o_rec_addr    , mode=IN   , jdbcType=VARCHAR}
				   ,#{o_rec_msg     , mode=IN   , jdbcType=VARCHAR}
				   ,#{o_order_num   , mode=OUT  , jdbcType=NUMERIC}
			)
		}
	</select>
	
	<insert id="htOrderDetailInsert" parameterType="java.util.Map" >
	    <foreach collection="list" item="item" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL">
			INTO order_detail (
							  O_ORDER_NUM,
							  NB_NUM,
							  O_DE_COUNT,
							  O_DE_PRODTYPE
							 )
					VALUES 	(
				             #{orderr.o_order_num}
				            ,#{item.nb_num}
				            ,#{item.c_count}
				            ,1
				            )
	   </foreach>
	</insert>
	
	<update id="htMemberPointUpdate" parameterType="Orderr">
		UPDATE member a
		SET    a.m_point  = (
			                 SELECT (aa.m_point + (#{o_pay_price}*0.01) - #{o_point})
			                 FROM   member aa 
			                 WHERE  aa.m_num = #{m_num}
			                 )
		 WHERE a.m_num = #{m_num}
	</update>
	
	<insert id="htPointInsert" parameterType="Orderr">
		INSERT INTO point_list
		VALUES (POINTLIST_P_NUM_SEQ.nextval, #{o_order_num}, #{m_num}, null, null, sysdate, 1, (#{o_pay_price} * 0.01))
	</insert>
	
	<delete id="htCartDelete">
		DELETE 
		FROM   cart
		WHERE  m_num = #{m_num}
	</delete>
	
		
</mapper>